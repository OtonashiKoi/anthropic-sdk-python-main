<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude 3.5 Sonnet 聊天界面</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/dark.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            100: '#1F2937',
                            200: '#374151',
                            300: '#4B5563',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .chat-container {
            height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .message-bubble {
            max-width: 70%;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        .user-message {
            background-color: #4B5563;
            border-radius: 1rem 1rem 0 1rem;
        }
        .assistant-message {
            background-color: #374151;
            border-radius: 1rem 1rem 1rem 0;
        }
        .code-block {
            position: relative;
            background-color: #2d2d2d;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #4a5568;
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .copy-button:hover {
            background-color: #2d3748;
        }
    </style>
</head>
<body class="bg-dark-100 text-gray-100 h-screen flex flex-col">
    <div class="container mx-auto p-4 flex-grow flex flex-col">
        <h1 class="text-2xl font-bold mb-4">Claude 3.5 Sonnet 聊天界面</h1>
        <div class="flex mb-4">
            <select id="groupSelect" class="p-2 border rounded-l-lg bg-dark-200 text-gray-100">
                <option value="default">默認群組</option>
            </select>
            <input type="text" id="newGroupInput" class="p-2 border bg-dark-200 text-gray-100" placeholder="新群組名稱">
            <button onclick="createNewGroup()" class="bg-green-600 text-white p-2 rounded-r-lg">創建新群組</button>
        </div>
        <div class="chat-container bg-dark-200 rounded-lg shadow mb-4">
            <div id="chatHistory" class="chat-history bg-dark-200"></div>
        </div>
        <div class="flex mb-2">
            <input type="text" id="userInput" class="flex-grow p-2 border rounded-l-lg bg-dark-200 text-gray-100" placeholder="輸入您的訊息...">
            <button onclick="sendMessage()" class="bg-blue-600 text-white p-2 rounded-r-lg">發送</button>
        </div>
        <div class="flex justify-between mb-4">
            <div>
                <button onclick="saveChat()" class="bg-purple-600 text-white p-2 rounded-lg mr-2">手動保存聊天記錄</button>
                <input type="file" id="loadFile" accept=".json" style="display: none;" onchange="loadChatFromFile(this.files[0])">
                <button onclick="document.getElementById('loadFile').click()" class="bg-yellow-600 text-white p-2 rounded-lg">從文件載入聊天記錄</button>
            </div>
            <div class="flex items-center">
                <label for="contextSize" class="mr-2">上下文消息數：</label>
                <select id="contextSize" class="p-2 border rounded-lg bg-dark-200 text-gray-100">
                    <option value="3">3</option>
                    <option value="5" selected>5</option>
                    <option value="10">10</option>
                    <option value="15">15</option>
                </select>
                <select id="modelSelect" class="ml-2 p-2 border rounded-lg bg-dark-200 text-gray-100">
                    <option value="claude-3-5-sonnet-20240620">Claude 3.5 Sonnet</option>
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        // 全局錯誤處理
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("全局錯誤:", message, "at", source, ":", lineno);
            addMessageToChat('system', `發生錯誤：${message}`);
        };

        // 未捕獲的 Promise 拒絕處理
        window.addEventListener('unhandledrejection', function(event) {
            console.error("未處理的 Promise 拒絕:", event.reason);
            addMessageToChat('system', `發生錯誤：${event.reason}`);
        });

        const API_URL = 'http://localhost:3000/api/chat';
        let groups = {
            default: []
        };
        let currentGroup = 'default';

        function createNewGroup() {
            const newGroupName = document.getElementById('newGroupInput').value.trim();
            if (newGroupName && !groups[newGroupName]) {
                groups[newGroupName] = [];
                const option = document.createElement('option');
                option.value = newGroupName;
                option.textContent = newGroupName;
                document.getElementById('groupSelect').appendChild(option);
                document.getElementById('newGroupInput').value = '';
                saveChat();
            }
        }

        document.getElementById('groupSelect').addEventListener('change', function(e) {
            currentGroup = e.target.value;
            updateChatHistory();
        });

        function updateChatHistory() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '';
            groups[currentGroup].forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.className = `mb-4 ${msg.role === 'user' ? 'text-right' : 'text-left'}`;
                
                const bubble = document.createElement('div');
                bubble.className = `message-bubble p-3 inline-block ${msg.role === 'user' ? 'user-message ml-auto' : 'assistant-message mr-auto'}`;
                
                const codeBlockRegex = /```[\s\S]*?```/g;
                let lastIndex = 0;
                let match;

                while ((match = codeBlockRegex.exec(msg.content)) !== null) {
                    if (match.index > lastIndex) {
                        bubble.appendChild(document.createTextNode(msg.content.slice(lastIndex, match.index)));
                    }

                    const codeBlock = document.createElement('div');
                    codeBlock.className = 'code-block';
                    const code = match[0].replace(/```/g, '').trim();
                    const pre = document.createElement('pre');
                    const codeElement = document.createElement('code');
                    codeElement.textContent = code;
                    pre.appendChild(codeElement);
                    codeBlock.appendChild(pre);

                    const copyButton = document.createElement('button');
                    copyButton.textContent = '複製';
                    copyButton.className = 'copy-button';
                    copyButton.onclick = function() {
                        navigator.clipboard.writeText(code).then(() => {
                            copyButton.textContent = '已複製!';
                            setTimeout(() => { copyButton.textContent = '複製'; }, 2000);
                        });
                    };
                    codeBlock.appendChild(copyButton);

                    bubble.appendChild(codeBlock);
                    lastIndex = match.index + match[0].length;
                }

                if (lastIndex < msg.content.length) {
                    bubble.appendChild(document.createTextNode(msg.content.slice(lastIndex)));
                }
                
                messageElement.appendChild(bubble);
                chatHistory.appendChild(messageElement);
            });
            scrollToBottom();

            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        }

        function scrollToBottom() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function sendMessage() {
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            if (!message) return;

            addMessageToChat('user', message);
            userInput.value = '';

            const selectedModel = document.getElementById('modelSelect').value;
            const contextSize = parseInt(document.getElementById('contextSize').value);

            try {
                let messagesToSend = [];
                
                if (groups[currentGroup].length > 0) {
                    const recentMessages = groups[currentGroup].slice(-contextSize * 2);
                    let lastRole = null;
                    for (const msg of recentMessages) {
                        if (msg.role !== lastRole) {
                            messagesToSend.push(msg);
                            lastRole = msg.role;
                        }
                    }

                    // 確保消息列表以 "user" 開始，以 "assistant" 結束
                    if (messagesToSend[0].role !== 'user') {
                        messagesToSend.shift();
                    }
                    if (messagesToSend[messagesToSend.length - 1].role !== 'assistant') {
                        messagesToSend.pop();
                    }
                }

                // 添加新的用戶消息
                messagesToSend.push({ role: 'user', content: message });

                console.log('Messages to send:', messagesToSend); // 用於調試

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: messagesToSend,
                        model: selectedModel,
                        max_tokens: 4000
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (data.content && Array.isArray(data.content) && data.content.length > 0) {
                    const assistantReply = data.content[0].text;
                    addMessageToChat('assistant', assistantReply);
                } else if (data.content && typeof data.content === 'string') {
                    addMessageToChat('assistant', data.content);
                } else {
                    throw new Error('Unexpected response format');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessageToChat('system', `發生錯誤：${error.message}`);
            }
        }

        function addMessageToChat(role, content) {
            groups[currentGroup].push({ role, content });
            updateChatHistory();
            saveChat(); // 每次添加消息後保存
        }

        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function saveChat() {
            localStorage.setItem('claudeChatGroups', JSON.stringify(groups));
            console.log('聊天記錄已保存到 localStorage');
        }

        function loadChat() {
            const savedChat = localStorage.getItem('claudeChatGroups');
            if (savedChat) {
                groups = JSON.parse(savedChat);
                updateGroupSelect();
                updateChatHistory();
                console.log('聊天記錄已從 localStorage 載入');
                return true;
            }
            return false;
        }

        function loadChatFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedGroups = JSON.parse(e.target.result);
                    groups = loadedGroups;
                    updateGroupSelect();
                    updateChatHistory();
                    saveChat(); // 保存到 localStorage
                    alert('聊天記錄已成功載入並保存到本地存儲');
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    alert('載入聊天記錄時發生錯誤');
                }
            };
            reader.readAsText(file);
        }

        function updateGroupSelect() {
            const groupSelect = document.getElementById('groupSelect');
            groupSelect.innerHTML = '';
            Object.keys(groups).forEach(groupName => {
                const option = document.createElement('option');
                option.value = groupName;
                option.textContent = groupName;
                groupSelect.appendChild(option);
            });
            currentGroup = Object.keys(groups)[0] || 'default';
            groupSelect.value = currentGroup;
        }

        // 頁面加載時自動載入聊天記錄
        window.onload = function() {
            if (!loadChat()) {
                console.log('沒有找到保存的聊天記錄');
            }
        };

        // 初始化
        updateChatHistory();
    </script>
</body>
</html>